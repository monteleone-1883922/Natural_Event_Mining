{% extends "base.html" %}

{% block title %}Correlation data analysis - Natural Events Dashboard{% endblock %}

{% block content %}
<main class="main-content">
    <div class="container-fluid px-4">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-database"></i> Correlation Data Analysis</h1>
            <p class="lead">Analysis of correlations between data columns</p>
        </div>

        <!-- Heatmap -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <i class="fas fa-th"></i> Top countries by events
                        <form id="eventTypeCorrelationForm" class="d-flex align-items-center" onsubmit="updateCorrelationByEventMatrix_prevent_default()">
                             <label for="eventTypeCorrelation" class="me-1 mb-0">EventType:</label>
                             <select id="eventTypeCorrelation" class="form-select form-select-sm me-2" style="width: 120px;">
                                 <option value="all">All</option>
                                 <option value="tornado">Tornado</option>
                                 <option value="eruption">Eruption</option>
                                 <option value="tsunami">Tsunami</option>
                                 <option value="earthquake">Earthquake</option>
                             </select>
                            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                        </form>
                        <button class="btn btn-sm btn-light" onclick="updateCorrelationByEventMatrix()" title="Reload chart">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Loading spinner -->
                        <div id="loading-correlationByEvent" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">Loading correlations by event...</div>
                        </div>
                        <!-- Chart container -->
                        <div id="correlationByEvent" class="chart-container" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <i class="fas fa-th"></i> Relations between events
                        <button class="btn btn-sm btn-light" onclick="reloadChart(
                            '/api/correlation_analysis/related_events',
                            'relatedEvents',
                            'loading-relatedEvents'
                        )" title="Reload chart">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Loading spinner -->
                        <div id="loading-relatedEvents" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">Loading related events...</div>
                        </div>
                        <!-- Chart container -->
                        <div id="relatedEvents" class="chart-container" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <i class="fas fa-th"></i> Missed relations between events
                        <form id="form_event_intensities" class="d-flex align-items-center" onsubmit="updateMissedRelations_prevent_default()">

                             <label for="missedRelationsRadius" class="me-1 mb-0">Max distance:</label>
                            <input type="number" id="missedRelationsRadius" class="form-control form-control-sm me-2" value="200" min="0" style="width: 80px;">


                            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                        </form>
                        <button class="btn btn-sm btn-light" onclick="updateMissedRelations()" title="Reload chart">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Loading spinner -->
                        <div id="loading-missedRelationsChart" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">Loading temporal distribution...</div>
                        </div>
                        <!-- Chart container -->
                        <div id="missedRelationsChart" class="chart-container" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Multiple Events Analysis -->
        <div class="row mt-4 mb-3">
            <div class="col-12">
                <div class="page-header">
                    <h3 class="mb-0"><i class="fas fa-layer-group"></i> Multiple Events Analysis</h3>
                    <p class="lead">Analysis of events of same type happened in same day</p>
                </div>
            </div>
        </div>

        <!-- Form Filtro -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="fas fa-filter"></i> Filter Settings</h6>
                        <div class="error-message-stats" id="errorMessageStats"></div>
                        <form id="filterFormStats" class="row g-3 align-items-end" onsubmit="update_cards()">
                            <div class="col-md-8 col-lg-9">
                                <label for="filterValueStats" class="form-label">Search radius (km):</label>
                                <input type="number" class="form-control" id="filterValueStats" min="1" step="1" value="200" required>
                                <small class="text-muted">Maximum distance to search for multiple events on the same day</small>
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary">Update Statistics</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards Eventi -->
        <div class="row mb-4 position-relative events-cards-container">
            <div class="loading-overlay-stats" id="loadingOverlayStats">
                <div class="spinner-stats"></div>
            </div>

            <!-- ERUPTIONS -->
            <div class="col-sm-6 col-lg-6 col-xl-3 mb-3">
                <div class="card event-card volcano-card h-100">
                    <div class="card-header-custom">
                        <div class="event-icon">üåã</div>
                        <h4 class="event-title">Eruptions</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-crown stat-icon text-warning"></i>
                                Max num events in same day
                            </div>
                            <div class="stat-value" id="eruption-max">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-calculator stat-icon text-primary"></i>
                                Avg num events in same day
                            </div>
                            <div class="stat-value" id="eruption-avg-multiple">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-route stat-icon text-info"></i>
                                Avg distance(Km)
                            </div>
                            <div class="stat-value" id="eruption-avg-distance">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-fire stat-icon text-danger"></i>
                                Avg VEI
                            </div>
                            <div class="stat-value" id="eruption-avg-intensity">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TSUNAMI -->
            <div class="col-sm-6 col-lg-6 col-xl-3 mb-3">
                <div class="card event-card tsunami-card h-100">
                    <div class="card-header-custom">
                        <div class="event-icon">üåä</div>
                        <h4 class="event-title">Tsunami</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-crown stat-icon text-warning"></i>
                                Max num events in same day
                            </div>
                            <div class="stat-value" id="tsunami-max">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-calculator stat-icon text-primary"></i>
                                Avg num events in same day
                            </div>
                            <div class="stat-value" id="tsunami-avg-multiple">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-route stat-icon text-info"></i>
                                Avg distance(Km)
                            </div>
                            <div class="stat-value" id="tsunami-avg-distance">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-water stat-icon text-primary"></i>
                                Avg max water height
                            </div>
                            <div class="stat-value" id="tsunami-avg-intensity">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TORNADO -->
            <div class="col-sm-6 col-lg-6 col-xl-3 mb-3">
                <div class="card event-card tornado-card h-100">
                    <div class="card-header-custom">
                        <div class="event-icon">üå™Ô∏è</div>
                        <h4 class="event-title">Tornado</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-crown stat-icon text-warning"></i>
                                Max num events in same day
                            </div>
                            <div class="stat-value" id="tornado-max">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-calculator stat-icon text-primary"></i>
                                Avg num events in same day
                            </div>
                            <div class="stat-value" id="tornado-avg-multiple">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-route stat-icon text-info"></i>
                                Avg distance(Km)
                            </div>
                            <div class="stat-value" id="tornado-avg-distance">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-wind stat-icon text-purple"></i>
                                Avg F scale
                            </div>
                            <div class="stat-value" id="tornado-avg-intensity">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EARTHQUAKES -->
            <div class="col-sm-6 col-lg-6 col-xl-3 mb-3">
                <div class="card event-card earthquake-card h-100">
                    <div class="card-header-custom">
                        <div class="event-icon">üèîÔ∏è</div>
                        <h4 class="event-title">Earthquakes</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-crown stat-icon text-warning"></i>
                                Max num events in same day
                            </div>
                            <div class="stat-value" id="earthquake-max">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-calculator stat-icon text-primary"></i>
                                Avg num events in same day
                            </div>
                            <div class="stat-value" id="earthquake-avg-multiple">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-route stat-icon text-info"></i>
                                Avg distance(Km)
                            </div>
                            <div class="stat-value" id="earthquake-avg-distance">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <i class="fas fa-house-damage stat-icon text-danger"></i>
                                Avg magnitude
                            </div>
                            <div class="stat-value" id="earthquake-avg-intensity">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

{% endblock %}

{% block extra_js %}
<script>
    // Carica il grafico percentuali
    loadChart(
        '/api/correlation_analysis/correlation_matrix/all',
        'correlationByEvent',
        'loading-correlationByEvent'
    );

    loadChart(
        '/api/correlation_analysis/related_events',
        'relatedEvents',
        'loading-relatedEvents'
    )

    loadChart(
        '/api/correlation_analysis/missed_relations/200',
        'missedRelationsChart',
        'loading-missedRelationsChart'
    )

    fetchEventStats(200);

    function updateCorrelationByEventMatrix() {
        const eventType = document.getElementById('eventTypeCorrelation').value;
        const url = `/api/correlation_analysis/correlation_matrix/${eventType}`;
        reloadChart(url, 'correlationByEvent', 'loading-correlationByEvent');
    }

    function updateCorrelationByEventMatrix_prevent_default(){
        event.preventDefault();
        updateCorrelationByEventMatrix()
    }

    function updateMissedRelations() {
        const radius = document.getElementById('missedRelationsRadius').value;
        const url = `/api/correlation_analysis/missed_relations/${radius}`;
        reloadChart(url, 'missedRelationsChart', 'loading-missedRelationsChart');
    }

    function updateMissedRelations_prevent_default() {
        event.preventDefault();
        updateMissedRelations();
    }

    function showLoadingStats() {
        document.getElementById('loadingOverlayStats').classList.add('active');
    }

    function hideLoadingStats() {
        document.getElementById('loadingOverlayStats').classList.remove('active');
    }

    function showErrorStats(message) {
        const errorDiv = document.getElementById('errorMessageStats');
        errorDiv.textContent = message;
        errorDiv.classList.add('active');
        setTimeout(() => {
            errorDiv.classList.remove('active');
        }, 5000);
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return 'Null';
        return typeof num === 'number' ? num.toLocaleString('en-US', {maximumFractionDigits: 2}) : num;
    }

    function updateCard(eventType, data) {
        document.getElementById(`${eventType}-max`).textContent = formatNumber(data.max_events);
        document.getElementById(`${eventType}-avg-multiple`).textContent = formatNumber(data.avg_multiple);
        document.getElementById(`${eventType}-avg-distance`).textContent = formatNumber(data.avg_distance);
        document.getElementById(`${eventType}-avg-intensity`).textContent = formatNumber(data.avg_intensity);
    }

    async function fetchEventStats(filterValue) {
        showLoadingStats();
        try {
            const response = await fetch(`/api/correlation_analysis/stats/${filterValue}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Aggiorna tutte le card
            if (data.eruption) updateCard('eruption', data.eruption);
            if (data.tsunami) updateCard('tsunami', data.tsunami);
            if (data.tornado) updateCard('tornado', data.tornado);
            if (data.earthquake) updateCard('earthquake', data.earthquake);

        } catch (error) {
            console.error('Error fetching event stats:', error);
            showErrorStats('Error loading data. Please try again.');
        } finally {
            hideLoadingStats();
        }
    }

    // Gestione del form
    function update_cards() {
        event.preventDefault();
        const filterValue = document.getElementById('filterValueStats').value;

        if (filterValue && parseInt(filterValue) > 20000) {
            showErrorStats('Radius value must be less than or equal to 20,000 km.');
        } else if (filterValue && parseInt(filterValue) > 0) {
            fetchEventStats(filterValue);
        } else {
            showErrorStats('Please enter a valid positive integer.');
        }
    }
</script>
{% endblock %}